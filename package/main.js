!function(t){var e={};function s(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)s.d(i,o,function(e){return t[e]}.bind(null,o));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=3)}([function(t,e){e.Component=class{constructor(){this._parent=null,this.id=$objc("NSUUID").$UUID().$UUIDString().rawValue(),this.children=[],this._layout=null,this.state={},this._stateValue={}}defineState(t){Object.entries(t).forEach(([t,e])=>{Object.defineProperty(this.state,t,{get:()=>this._stateValue[t],set:e=>{throw Error(`Trying to assign a value ${e} to "${t}" by assignment op (=). Use setState() instead.`)}}),this._stateValue[t]=e})}setState(t){Object.entries(t).forEach(([t,e])=>{if(!this._stateValue.hasOwnProperty(t))throw $ui.toast(`No such state: ${t} in ${this.constructor.name}`),`No such state: ${t}`;this._stateValue[t]=e}),this._onStateChange()}set layout(t){this._layout=t}get layout(){return this._layout}get rendered(){return!!this.element}get element(){return $(this.id)}set parent(t){this._parent=t}_onStateChange(){this.rendered&&console.error("Should be re-rendered. OK?"),this.render()}addChild(t){return this.children.push(t),t.parent=this,this}removeChild(t){let e=this.children.indexOf(t);if(!(e>=0))throw"Child not found";this.children[e].element.remove(),this.children.splice(e,1)}removeMe(){this._parent.removeChild(this)}get runtime(){return this.element.runtimeValue()}build(){throw"Implement build() method"}buildSource(){console.log("Build "+this.constructor.name);const t=this.build();if(t){if(t.props.id=this.id,this.layout){const e=t.layout,s=this.layout;t.layout=(t,i)=>{e(t,i),s(t,i)}}t.views||(t.views=[]),t.views=t.views.concat(this.children.map(t=>t.buildSource()).filter(t=>t))}return t}render(){const t=this.buildSource();this._parent?(this.element&&this.element.remove(),$(this._parent.id).add(t)):(console.log("Root element. call $ui.render(): "+t.type),$ui.render(t))}}},function(t,e,s){const{Component:i}=s(0),o=$color("#c6c6c6"),r=$color("#bbbbbb"),n=$color("#DDDDDD");function a(t,e,s,i=!1,o=!1,r=5){return o&&(t=t.toLowerCase()),new Promise((n,a)=>{let l,c=[];for(let a=0;a<e.length;++a){l=i?e.length-1-a:a;let u=e[l].replace(/^https?:\/\//,""),h=s[l];if(o&&(h=h.toLowerCase()),(u.indexOf(t)>=0||h.indexOf(t)>=0)&&(c.push(l),c.length>=r))return void n(c)}n(c)})}class l{constructor(t,e){this.text=t,this.url=e}get urlReadable(){return decodeURIComponent(this.url.replace(/^https?:\/\//,""))}static async generateByQuery(t,e){throw"Implement"}static execAction(t,e){e.visitURL(t.url),e.blurLocationBar()}get iconType(){return"star.fill"}get icon(){return $icon(this.iconType,$rgba(140,140,140,.8),$size(13,13))}}class c extends l{constructor(t,e,s){super(t,e),this.tabIndex=s}get iconType(){return"macwindow"}static execAction(t,e){e.blurLocationBar(),e.selectTab(t.tabIndex)}static async generateByQuery(t,e){const s=e._tabs.map(t=>t.url),i=e._tabs.map(t=>t.title);return(await a(t,s,i,!1,!0)).map(t=>new c(i[t],s[t],t))}}class u extends l{constructor(t,e){super(t,e)}get iconType(){return"clock"}static execAction(t,e){e.visitURL(t.url),e.blurLocationBar()}static async generateByQuery(t,e){const s=e._pastURLs,i=e._pastTitles;return(await a(t,s,i,!0,!0)).map(t=>new u(i[t],s[t]))}}class h extends l{constructor(t,e){super(t,e)}get iconType(){return"star.fill"}static execAction(t,e){e.visitURL(t.url),e.blurLocationBar()}static async generateByQuery(t,e){let s=e.bookmarks;return(await a(t,s.map(t=>t.url),s.map(t=>t.title),!1,!0)).map(t=>new h(s[t].title,s[t].url))}}const d="https://www.google.com/complete/search?client=chrome-omni&gs_ri=chrome-ext&oit=1&cp=1&pgcl=7&q=";class p extends l{constructor(t,e){super(t,"Suggested by "+e)}get urlReadable(){return this.url}get iconType(){return"magnifyingglass"}static execAction(t,e){e.visitURL(t.text),e.blurLocationBar()}static generateByQuery(t,e,s=d){const i=d+encodeURIComponent(t);return new Promise((t,e)=>{$http.request({method:"GET",url:i,handler:function(s){s.error?e(s.error):t(s.data[1].map(t=>new p(t,"Google")))}})})}}class b extends l{constructor(t,e){super(t,e)}get iconType(){return"dollarsign.square"}static generateByQuery(t,e){const s=e.config.SCRAPBOX_USER,i=`https://scrapbox.io/api/pages/${s}/search/query?skip=0&sort=updated&limit=30&q=`+encodeURIComponent(t);return new Promise((t,e)=>{$http.request({method:"GET",url:i,handler:function(e){e.error||401===e.data.statusCode?t(null):t(e.data.pages.map(t=>new b(t.title,`https://scrapbox.io/${s}/${encodeURIComponent(t.title)}`)))}})})}}e.LocationBarCompletion=class extends i{constructor(t,e,s=40){super(),this._browser=t,this._locationBar=null,this._canceled=!1,this.TOPBAR_HEIGHT=e,this.CANDIDATE_HEIGHT=s,this.defineState({suggestionList:null,suggestionIndex:-1})}set locationBar(t){this._locationBar=t}get suggestionIndex(){return this.state.suggestionIndex}get suggestionSelected(){return this.state.suggestionIndex>=0}set suggestions(t){this.setSuggestions(t)}setSuggestions(t,e=-1){t&&e>=0&&(e=Math.min(e,t.length-1)),this.setState({suggestionList:t,suggestionIndex:e})}reset(){this._canceled=!1}cancel(){this._canceled=!0,this.suggestions=null}get canceled(){return this._canceled}decide(t){if("number"!=typeof t&&(t=this.state.suggestionIndex),t>=0){let e=this.state.suggestionList[t];e.constructor.execAction(e,this._browser)}}selectNextCandidate(){this.state.suggestionIndex<0?this.setState({suggestionIndex:0}):this.setState({suggestionIndex:(this.state.suggestionIndex+1)%this.state.suggestionList.length})}selectPreviousCandidate(){let t=-1;t=this.state.suggestionIndex<0?this.state.suggestionList.length-1:this.state.suggestionIndex-1<0?this.state.suggestionList.length-1:this.state.suggestionIndex-1,this.setState({suggestionIndex:t})}build(){const t=this.state.suggestionList,e=this.state.suggestionIndex,s={props:{},views:[{type:"view",props:{id:"completion-rectangle",bgcolor:$color("#FFFFFF")},layout:$layout.fill,views:[{type:"view",layout:(t,e)=>{t.width.equalTo(32),t.height.equalTo(e.super)},views:[{type:"button",props:{id:"completion-icon",bgcolor:$color("clear"),align:$align.center},layout:(t,e)=>{t.centerX.equalTo(e.super),t.centerY.equalTo(e.super)}}]},{type:"view",layout:(t,e)=>{t.width.equalTo(e.super).offset(32),t.height.equalTo(e.super),t.left.equalTo(32)},views:[{type:"label",props:{id:"completion-label",align:$align.left,font:$font(15),borderWidth:0,textColor:$color("#000000")},layout:(t,e)=>{t.top.inset(3),t.left.inset(3),t.width.equalTo(e.super.width)}},{type:"label",props:{id:"completion-url",align:$align.left,font:$font(12),textColor:$rgba(0,0,0,.6)},layout:(t,e)=>{t.bottom.inset(3),t.left.inset(3),t.width.equalTo(e.super.width)}}]}]}]},i=(t||[]).map((t,s)=>{let i={"completion-label":{text:t.text,tabIndex:s},"completion-url":{text:t.urlReadable},"completion-icon":{}};return/^[0-9]+$/.test(t.iconType)?i["completion-icon"].icon=t.icon:i["completion-icon"].symbol=t.iconType,s===e&&(i["completion-rectangle"]={bgcolor:n}),i});let a=0===(t||[]).length;return{type:"list",events:{didSelect:(t,e)=>{this.decide(e.row)}},props:{id:"completion-list",rowHeight:this.CANDIDATE_HEIGHT,template:s,data:i,bgColor:r,borderWidth:1,radius:5,borderColor:o,hidden:a},layout:(e,s)=>{let i=this._locationBar.element;e.centerX.equalTo(i.centerX),e.width.equalTo(i).priority(1),e.height.equalTo(this.CANDIDATE_HEIGHT*(t||[]).length).priority(1);const o=this.TOPBAR_HEIGHT*this._locationBar.HEIGHT_RATIO;e.top.equalTo(o+(this.TOPBAR_HEIGHT-o)/2+1)}}}},e.Suggestion=l,e.SuggestionTab=c,e.SuggestionBookmark=h,e.SuggestionWebQuery=p,e.SuggestionHistory=u,e.SuggestionScrapbox=b},function(t,e,s){const{Component:i}=s(0),o=15,r=$rgba(250,250,250,.9),n=$color("#000000"),a=$color("#cccccc"),l=$color("#666666"),c=$color("#bbbbbb");class u extends i{constructor(t){super(),this.config=t.config,this._browser=t,this._eventHandlers={didSelect:(t,e)=>{this._browser.selectTab(e.row)},didLongPress:(e,s)=>{const i=[["Copy",()=>t.copyTabInfo(s.row)],["Close other tabs",()=>t.closeTabsBesides(s.row)],["Open in external browser",()=>t.openInExternalBrowser(s.row)]];$ui.menu({items:i.map(t=>t[0]),handler:function(t,e){e>=0&&i[e][1]()},finished:function(t){}})}},this._tabTemplate={props:{},views:[{type:"view",props:{id:"tab-rectangle"},layout:$layout.fill,views:[{type:"label",props:{id:"tab-name",align:$align.center,font:$font(this.config.SIZE_TAB_FONT)},layout:(t,e)=>{t.height.equalTo(e.super.height),t.width.equalTo(e.super.width).offset(-30),t.left.equalTo(e.super.left).offset(25)}}]},{type:"button",props:{id:"close-button",icon:$icon("225",$rgba(140,140,140,.8),$size(o,o)),bgcolor:$color("clear")},events:{tapped:async()=>{t.closeCurrentTab()}},layout:(t,e)=>{t.left.equalTo(e.super.left).offset(5),t.top.inset(5)}}]}}get tabNames(){return this._browser._tabs.map(t=>t.title)}get currentTabIndex(){return this._browser.currentTabIndex}build(){const t=this.tabNames.map((t,e)=>e===this.currentTabIndex?{"tab-name":{text:t},"tab-rectangle":{bgcolor:r,textColor:n,tabIndex:e}}:{"tab-name":{text:t},"tab-rectangle":{bgcolor:a,textColor:l,tabIndex:e},"close-button":{hidden:!0}});return t&&0!==t.length?this._buildTabList(t):null}}e.TabListHorizontal=class extends u{constructor(t){super(t),this.config=t.config}_buildTabList(t){return{type:"matrix",events:this._eventHandlers,props:{id:"pages-tab",columns:t.length,itemHeight:this.config.TAB_HEIGHT,spacing:0,template:this._tabTemplate,data:t},layout:(t,e)=>{t.width.equalTo(e.super),t.height.equalTo(this.config.TAB_HEIGHT),t.top.equalTo(e.super),t.left.equalTo(e.super)}}}},e.TabListVertical=class extends u{constructor(t){super(t),this.config=t.config}_buildTabList(t){return{type:"list",events:this._eventHandlers,props:{id:"pages-tab",rowHeight:this.config.TAB_HEIGHT,template:this._tabTemplate,data:t,bgcolor:c,borderWidth:0},layout:(t,e)=>{t.width.equalTo(this.config.TAB_VERTICAL_WIDTH),t.height.equalTo(e.super),t.top.equalTo(e.super),t.left.equalTo(e.super)}}}}},function(module,exports,__webpack_require__){const{TabContentWebView:TabContentWebView}=__webpack_require__(4),{Component:Component}=__webpack_require__(0),{ToolBar:ToolBar}=__webpack_require__(5),{ToolBarButton:ToolBarButton}=__webpack_require__(6),{ToolBarButtonContainer:ToolBarButtonContainer}=__webpack_require__(7),{LocationBar:LocationBar}=__webpack_require__(8),{LocationBarCompletion:LocationBarCompletion}=__webpack_require__(1),{TabListHorizontal:TabListHorizontal}=__webpack_require__(2),{TabListVertical:TabListVertical}=__webpack_require__(2);function readMinified(t){return $file.exists(t+".min.js")?$file.read(t+".min.js").string:$file.read(t+".js").string}function loadTabInfo(){try{let[t,e,s]=JSON.parse($file.read("last-tabs.json").string.trim());if(t.length!==s.length)throw"Invalid";return[t,e,s]}catch(t){return[[],0,[]]}}function saveTabInfo(t){let e=t._tabs.map(t=>t.url),s=t._tabs.map(t=>t.title),i=[e,t.currentTabIndex,s];$file.write({data:$data({string:JSON.stringify(i)}),path:"last-tabs.json"})}function loadHistory(){try{let t=JSON.parse($file.read("history.json").string.trim());if(!Array.isArray(t.pages))throw"Error";if(!Array.isArray(t.bookmarks))throw"Error";return t}catch(t){return{page:{urls:[],titles:[]},bookmark:[]}}}function saveHistory(t){$file.write({data:$data({string:JSON.stringify(t.history)}),path:"history.json"})}function loadConfig(){let userSettings=readMinified("./settings");eval(userSettings);const config={sites:[]};return exports.setup(config,{marked:()=>null}),config}function readUserScript(){let t=readMinified("./settings");return readMinified("./content-script").replace("/*@preserve SETTINGS_HERE*/","\n"+t+"\n")}function convertURLLikeInputToURL(t){return/^https?:/.test(t)||"about:blank"===t?t:"https://www.google.com/search?q="+encodeURIComponent(t)}class TabAndContentContainer extends Component{constructor(t){super(),this._verticalOffset=t}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(t,e)=>{t.width.equalTo(e.super.width),t.height.equalTo(e.super.height).offset(-this._verticalOffset),t.top.equalTo(e.super.top).offset(this._verticalOffset),t.left.equalTo(e.super)}}}}class TabContentHolder extends Component{constructor(t){super(),this.config=t.config}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(t,e)=>{this.config.TAB_VERTICAL?(t.width.equalTo(e.super.width).offset(-this.config.TAB_VERTICAL_WIDTH),t.height.equalTo(e.super.height),t.top.equalTo(e.super.top),t.left.equalTo(e.super).offset(this.config.TAB_VERTICAL_WIDTH)):(t.width.equalTo(e.super.width),t.height.equalTo(e.super.height),t.top.equalTo(e.super.top).offset(this.config.TAB_HEIGHT),t.left.equalTo(e.super))}}}}class TabBrowser extends Component{constructor(t,e,s){super(),this._config=s,this.userScript=t,this.currentTabIndex=0,this._tabs=[],this._closedTabs=[],this._pastURLs=[],this._pastTitles=[],this._onInitialize=e;const i=s.TOPBAR_HEIGHT;let o=new ToolBarButtonContainer("left",.25),r=new ToolBarButtonContainer("right",.25),n=new LocationBarCompletion(this,i);const a=new LocationBar(this,n,.5);this._locationBar=a,n.locationBar=a;const l=new ToolBar(i);this._toolbar=l;const c=new TabAndContentContainer(i);this._tabAndContentContainer=c;const u=new TabContentHolder(this);this._tabContentHolder=u;const h=s.TAB_VERTICAL?new TabListVertical(this):new TabListHorizontal(this);this._tabList=h,r.addChild(new ToolBarButton("rectangle.on.rectangle",()=>this.selectTabsByPanel())).addChild(new ToolBarButton("plus",()=>this.createNewTab(null,!0))).addChild(new ToolBarButton("square.and.arrow.up",()=>this.share())),o.addChild(new ToolBarButton("multiply",()=>$app.close())).addChild(new ToolBarButton("chevron.left",()=>this.goBack())).addChild(new ToolBarButton("chevron.right",()=>this.goForward())).addChild(new ToolBarButton("book",()=>this.showBookmark())),l.addChild(o).addChild(a).addChild(r),c.addChild(h).addChild(u),this.addChild(n).addChild(l).addChild(c),this.render()}get config(){return this._config}build(){return{props:{id:this.id,title:"iKeySnail",statusBarHidden:this.config.HIDE_STATUSBAR,navBarHidden:this.config.HIDE_TOOLBAR},events:{appeared:t=>{this._onInitialize(this)}}}}focusLocationBar(){this._locationBar.focus()}blurLocationBar(){this._locationBar.blur()}decideLocationBarCandidate(){this._locationBar.decideCandidate()}selectLocationBarNextCandidate(){this._locationBar.selectNextCandidate()}selectLocationBarPreviousCandidate(){this._locationBar.selectPreviousCandidate()}get history(){return{page:{urls:this._pastURLs,titles:this._pastTitles},bookmark:{}}}set history(t){this._pastURLs=t.page.urls,this._pastTitles=t.page.titles,this._bookmark=t.bookmark}addHistory(t,e){this._pastURLs.push(t),this._pastTitles.push(e)}get bookmarks(){return this.config.sites.map(t=>({title:t.alias,url:t.url}))}get selectedTab(){return this._tabs[this.currentTabIndex]}selectTabsByPanel(){let t=this._tabs.map((t,e)=>({text:t.title,url:t.url})),e=this._tabs.indexOf(this.selectedTab);this.selectedTab.evalScript(`\n__keysnail__.runPanel(${JSON.stringify(t)}, {\n  toggle: true,\n  initialIndex: ${e},\n  action: index => $notify("selectTabByIndex", { index })\n});\n        `)}onTabStartLoading(t){t===this.selectedTab&&this.setURLView(t.url)}onTabTitleDetermined(t){this.addHistory(t.url,t.title)}onTabURLChanged(t){t===this.selectedTab&&this.setURLView(t.url)}focusContent(){this.selectedTab.select()}setURLView(t){this._locationBar.setURLText(t)}visitURL(t){t=convertURLLikeInputToURL(t),this.selectedTab.visitURL(t),this.setURLView(t),this.selectedTab.select()}showBookmark(){this.selectedTab.showBookmark()}goBack(){this.selectedTab.goBack()}goForward(){this.selectedTab.goForward()}share(){let t=this.selectedTab;$share.sheet([t.url,t.title])}scrap(){let t=this.selectedTab,e=`#bookmark\n\n${t.url}\n`;this.createNewTab(`https://scrapbox.io/${this.config.SCRAPBOX_USER}/${encodeURIComponent(t.title)}?body=${encodeURIComponent(e)}`,!0)}copyTabInfo(t){$clipboard.set({type:"public.plain-text",value:this._tabs[t].url})}openInExternalBrowser(t){$app.openURL(this._tabs[t].url)}closeTabsBesides(t){let e=this._tabs[t];this._tabs.forEach((e,s)=>{this._closedTabs.push({url:e.url,title:e.title}),s!==t&&e.loaded&&(e.visitURL(null),e.removeMe())}),this._tabs=[e],this.selectTab(0)}closeCurrentTab(){return this.closeTab(browser._tabs[browser.currentTabIndex])}closeTab(t){if(this._closedTabs.push({url:t.url,title:t.title}),this._tabs.length<=1)this._tabs[0].visitURL(this.config.NEW_PAGE_URL);else{t.visitURL(null);let e=this._tabs.indexOf(t);t.removeMe(),e>=0&&this._tabs.splice(e,1),this.selectTab(Math.max(0,this.currentTabIndex-1))}}_createNewTabInternal(t,e=null){let s=new TabContentWebView(this,this.config,t,this.userScript);return e&&(s._title=e),this._tabContentHolder.addChild(s),this._tabs.push(s),s}createNewTabs(t,e=-1,s=[]){t.forEach((t,e)=>{let i=s?s[e]:null;this._createNewTabInternal(t,i)}),e>=0&&this.selectTab(e)}createNewTab(t,e=!1){t||(t=this.config.NEW_PAGE_URL),t=convertURLLikeInputToURL(t);let s=this._createNewTabInternal(t);e?this.selectTab(this._tabs.indexOf(s)):this._tabList.render()}selectTab(t){this.currentTabIndex=t,this._tabs.forEach((e,s)=>{s===t?(e.select(),this.setURLView(e.url)):e.deselect()}),this._tabList.render()}selectNextTab(){this.selectTab((this.currentTabIndex+1)%this._tabs.length)}selectPreviousTab(){this.currentTabIndex-1<0?this.selectTab(this._tabs.length-1):this.selectTab(this.currentTabIndex-1)}undoClosedTab(){if(!this._closedTabs.length)return void $ui.toast("No closed tabs in the history",.7);let t=this._closedTabs.pop();this.createNewTab(t.url,!0)}}function startSession(t){const e=loadConfig();let s=[],i=0;try{let[t,e,o]=loadTabInfo();i=e,o=o||[];for(let e=0;e<t.length;++e)s.push({url:t[e],title:o[e]})}catch(t){}let o=new TabBrowser(readUserScript(),o=>{o.history=loadHistory(),s.length?(o.createNewTabs(s.map(t=>t.url),i,s.map(t=>t.title)),t?o.createNewTab(t,!0):o.selectTab(i)):o.createNewTab(t||e.NEW_TAB_URL,!0)},e);$app.listen({ready:()=>{$define({type:"UIResponder",events:{"_keyCommandForEvent:":t=>null}});let t=!1,s=!1,i=!1,r=o._locationBar.runtime;const n={option:226,meta:227,Escape:41,Enter:40,ctrl:224," ":44};for(let t=0;t<27;++t)n[String.fromCharCode(97+t)]=4+t;if(e.SWAP_COMMAND_OPTION){let t=n.option;n.option=n.meta,n.meta=t}Object.freeze(n);const a=function(t){const e={};return Object.keys(t).forEach(s=>{e[t[s]]=s}),e}(n);let l={"ctrl-p":()=>o.selectLocationBarPreviousCandidate(),"ctrl-n":()=>o.selectLocationBarNextCandidate(),"ctrl-m":()=>o.decideLocationBarCandidate(),"ctrl-g":()=>o.blurLocationBar(),"ctrl-meta-j":()=>o.selectNextTab(),"ctrl-meta-k":()=>o.selectPreviousTab(),Escape:()=>o.blurLocationBar()},c={"ctrl-meta-j":()=>o.selectNextTab(),"ctrl-meta-k":()=>o.selectPreviousTab(),"meta-l":()=>o.focusLocationBar()};e.CAPTURE_CTRL_SPACE&&(c["ctrl- "]=()=>o.selectedTab.dispatchCtrlSpace()),$define({type:"UIApplication",events:{"_handleKeyUIEvent:":e=>{const o=e.$__keyCode(),u=e.$__isKeyDown(),h=a[o];if(!a.hasOwnProperty(o))return self.$ORIG__handleKeyUIEvent(e);let d=c;if(r.$isFirstResponder()&&(d=l),o===n.ctrl)t=u;else if(o===n.meta)s=u;else if(o===n.option)i=u;else{let o=h;if(s&&(o="meta-"+o),t&&(o="ctrl-"+o),i&&(o="alt-"+o),d.hasOwnProperty(o)){if("ctrl-m"===o&&r.$markedTextRange())return self.$ORIG__handleKeyUIEvent(e);if(u)try{d[o]()}catch(t){}return null}}return self.$ORIG__handleKeyUIEvent(e)}}})},exit:()=>{try{$objc("RedBoxCore").$cleanClass("UIResponder"),$objc("RedBoxCore").$cleanClass("UIApplication")}catch(t){console.error(t)}saveTabInfo(o),saveHistory(o)}})}startSession($context.query.url||null)},function(t,e,s){const{Component:i}=s(0);function o(t,e,s=!0){return s?new Promise((s,i)=>{t.element.eval({script:e,handler:(t,e)=>{e||"object"==typeof t?i(e):s(t)}})}):(t.element.eval({script:e}),null)}e.TabContentWebView=class extends i{constructor(t,e,s="http://www.google.com",i=""){super(),this.browser=t,this.config=e,this.userScript=i,this._title=s,this.url=s,this._loaded=!1;let r=this;this.eventHandler={log:({message:t})=>{this.config.DEBUG_CONSOLE&&log(t)},titleDetermined:({title:t})=>{"about:blank"===this.element.url?this.title="New Tab":this.title=t,this.browser.onTabTitleDetermined(this)},decideNavigation:(t,e)=>!!e.runtimeValue().$targetFrame()||(this.browser.createNewTab(e.requestURL,!0),!1),didFinish:async t=>{},didStart:t=>{this.title="Loading ...",this.browser.onTabStartLoading(this)},urlDidChange:async t=>{this.title=await o(r,"document.title",!0),this.browser.onTabURLChanged(this)},exitApplication:()=>$app.close(),share:()=>this.browser.share(),scrap:()=>this.browser.scrap(),message:({message:t,duration:e})=>{$ui.toast(t,e||3)},paste:()=>{o(r,`__keysnail__.insertText('${escape($clipboard.text)}', true)`,!1)},closeTab:()=>{this.browser.closeTab(r)},createNewTab:t=>{let{url:e,openInBackground:s}=t||{url:null,openInBackground:!1};this.browser.createNewTab(e||"about:blank",!s),e||this.browser.focusLocationBar()},selectNextTab:()=>{this.browser.selectNextTab()},selectPreviousTab:()=>{this.browser.selectPreviousTab()},undoClosedTab:()=>{this.browser.undoClosedTab()},focusLocationBar:()=>{this.browser.focusLocationBar()},copyText:({text:t})=>{$clipboard.set({type:"public.plain-text",value:t})},openClipboardURL:async()=>{let t=await o(r,"__keysnail__.getSelectedText()");t||(t=$clipboard.text),this.browser.createNewTab(t,!0)},selectTabsByPanel:()=>{t.selectTabsByPanel()},selectTabByIndex:({index:t})=>{this.browser.selectTab(t)}}}destroy(){this.visitURL(null),this.removeMe()}get selected(){return this===this.browser.selectedTab}get loaded(){return this._loaded}deselect(){this.element&&(this.element.hidden=!0)}select(){this.load(),this.element.hidden&&(this.element.hidden=!1),this.runtimeWebView.$becomeFirstResponder()}set url(t){this._url=t,this._loaded&&(this.element.url=t)}get url(){let t=null;return(t=this.element?this.element.url:this._url)||this.config.NEW_PAGE_URL}get element(){return $(this.id)}get title(){return this._title}set title(t){this._title=t,this.browser._tabList.render()}showBookmark(){o(this,"__keysnail__.startSiteSelector(true)")}goBack(){this.element.goBack()}goForward(){this.element.goForward()}visitURL(t){this.url=t}load(){this._loaded||(this._loaded=!0,this.render(),this.runtimeWebView.$setAllowsBackForwardNavigationGestures(!0))}get runtimeWebView(){return this.element.runtimeValue()}unload(){this._loaded&&(this._loaded=!1,this.element.url=null,this.element.remove())}dispatchCtrlSpace(){o(this,'__keysnail__.dispatchKey("ctrl- ", false, true)')}build(){if(!this._loaded)return null;let t=this.url,e=this.userScript;return{type:"web",props:{id:this.id,ua:this.config.USER_AGENT,script:e,hidden:!1,url:t},events:this.eventHandler,layout:(t,e)=>{t.edges.equalTo(e.super)}}}evalScript(t){return new Promise((e,s)=>{this.element.eval({script:t,handler:(t,i)=>{i||"object"==typeof t?s(i):e(t)}})})}}},function(t,e,s){const{Component:i}=s(0);e.ToolBar=class extends i{constructor(t){super(),this._height=t}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(t,e)=>{t.width.equalTo(e.super),t.height.equalTo(this._height)}}}}},function(t,e,s){const{Component:i}=s(0),o=18,r=$color("#007AFF");e.ToolBarButton=class extends i{constructor(t,e){super(),this._iconOrSymbol=t,this._onTapped=e,this._padding=30}build(){const t={type:"button",props:{bgcolor:$color("clear")},events:{tapped:this._onTapped},layout:(t,e)=>{const s=this._parent.element.views,i=s.indexOf(e);if("left"===this._parent.align){const o=0===i?e.super.left:s[i-1].right;t.left.equalTo(o).offset(this._padding)}else{const o=0===i?e.super.right:s[i-1].left;t.right.equalTo(o).offset(-this._padding)}t.centerY.equalTo(e.super),t.height.equalTo(e.super)}};return/^[0-9]+$/.test(this._iconOrSymbol)?t.props.icon=$icon(this._iconOrSymbol,r,$size(o,o)):(t.props.symbol=this._iconOrSymbol,t.props.tintColor=r),t}}},function(t,e,s){const{Component:i}=s(0);e.ToolBarButtonContainer=class extends i{constructor(t="left",e=.5,s=$color("clear")){super(),this._align=t,this._bgcolor=s,this.WIDTH_RATIO=e}get align(){return this._align}build(){return{type:"view",props:{bgcolor:this._bgcolor},layout:(t,e)=>{t.top.equalTo(e.super.top),t.height.equalTo(e.super.height),t.width.equalTo(e.super.width).multipliedBy(this.WIDTH_RATIO),"left"===this._align?t.left.inset(0):t.right.inset(0)}}}}},function(t,e,s){const{Component:i}=s(0),{LocationBarCompletion:o}=s(1),r="#2B9E46";e.LocationBar=class extends i{constructor(t,e,s=.5,i=.65){super(),this._browser=t,this._completion=e,this.WIDTH_RATIO=s,this.HEIGHT_RATIO=i}focus(){this.element.focus(),this.runtime.$selectAll(),this._completion.reset()}blur(){this.element.blur(),this._browser.focusContent()}setURLText(t){this.element.text=decodeURIComponent(t)}build(){let t=this._browser,e=null;const i=function(t,e=500){let s=null;return(...i)=>{s&&clearTimeout(s),s=setTimeout(async()=>{t(...i)},e)}}(async(e,i)=>{if(e.length<1)return void(this._completion.suggestions=null);if(this._completion.canceled)return;const o=this._browser.config.LOCATIONBAR_SUGGESTIONS.map(i=>{if("string"==typeof i){i=s(1)[i]}return i.generateByQuery(e,t)});if(this._browser.config.LOCATIONBAR_SUGGESTIONS_SYNCED){let t=await Promise.all(o);if(t=t.filter(t=>!!t).map(t=>t.slice(0,5)).flat(),this._completion.canceled)return;this._completion.suggestions=t}else{let t=[];o.forEach(e=>{e.then(e=>{e&&(t=t.concat(e.slice(0,5))),this._completion.canceled||this._completion.setSuggestions(t,this._completion.suggestionSelected?this._completion.suggestionIndex:-1)})})}},100);return{type:"input",props:{id:this.id,textColor:$color(r),align:$align.center},layout:(t,e)=>{t.centerY.equalTo(e.super.center),t.height.equalTo(e.super.height).multipliedBy(this.HEIGHT_RATIO),t.width.equalTo(e.super.width).multipliedBy(this.WIDTH_RATIO),t.centerX.equalTo(e.super.center).priority(100)},events:{didBeginEditing:t=>{t.align=$align.left,t.textColor=$rgba(0,0,0,1),e=t.text},tapped:t=>{this.focus()},returned:t=>{this.decideCandidate()},didEndEditing:t=>{this._completion.cancel(),t.align=$align.center,t.textColor=$color(r),t.text=e},changed:t=>{(t=>/https?:\/\//.test(t))(t.text)||i(t.text,t)}}}}decideCandidate(){this._completion.suggestionSelected?this._completion.decide():(this._browser.visitURL(this.element.text),this._browser.focusContent())}selectNextCandidate(){this._completion.selectNextCandidate()}selectPreviousCandidate(){this._completion.selectPreviousCandidate()}}}]);