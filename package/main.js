!function(e){var t={};function i(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(s,o,function(t){return e[t]}.bind(null,o));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,t){t.Component=class{constructor(){this._parent=null,this.id=$objc("NSUUID").$UUID().$UUIDString().rawValue(),this.children=[],this._layout=null,this.state={},this._stateValue={}}defineState(e){Object.entries(e).forEach(([e,t])=>{Object.defineProperty(this.state,e,{get:()=>this._stateValue[e],set:t=>{throw Error(`Trying to assign a value ${t} to "${e}" by assignment op (=). Use setState() instead.`)}}),this._stateValue[e]=t})}setState(e){Object.entries(e).forEach(([e,t])=>{if(!this._stateValue.hasOwnProperty(e))throw $ui.toast(`No such state: ${e} in ${this.constructor.name}`),`No such state: ${e}`;this._stateValue[e]=t}),this._onStateChange()}set layout(e){this._layout=e}get layout(){return this._layout}get rendered(){return!!this.element}get element(){return $(this.id)}set parent(e){this._parent=e}_onStateChange(){this.rendered&&console.error("Should be re-rendered. OK?"),this.render()}addChild(e){return this.children.push(e),e.parent=this,this}removeChild(e){let t=this.children.indexOf(e);if(!(t>=0))throw"Child not found";this.children[t].element.remove(),this.children.splice(t,1)}removeMe(){this._parent.removeChild(this)}get runtime(){return this.element.runtimeValue()}build(){throw"Implement build() method"}buildSource(){console.log("Build "+this.constructor.name);const e=this.build();if(e){if(e.props.id=this.id,this.layout){const t=e.layout,i=this.layout;e.layout=(e,s)=>{t(e,s),i(e,s)}}e.views||(e.views=[]),e.views=e.views.concat(this.children.map(e=>e.buildSource()).filter(e=>e))}return e}render(){const e=this.buildSource();this._parent?(this.element&&this.element.remove(),$(this._parent.id).add(e)):(console.log("Root element. call $ui.render(): "+e.type),$ui.render(e))}}},function(e,t,i){const{Component:s}=i(0),o=$color("#c6c6c6"),r=$color("#bbbbbb"),n=$color("#DDDDDD");function a(e,t,i,s=!1,o=!1,r=5){return o&&(e=e.toLowerCase()),new Promise((n,a)=>{let l,c=[];for(let a=0;a<t.length;++a){l=s?t.length-1-a:a;let u=t[l].replace(/^https?:\/\//,""),h=i[l];if(o&&(h=h.toLowerCase()),(u.indexOf(e)>=0||h.indexOf(e)>=0)&&(c.push(l),c.length>=r))return void n(c)}n(c)})}class l{constructor(e,t){this.text=e,this.url=t}get urlReadable(){return decodeURIComponent(this.url.replace(/^https?:\/\//,""))}static async generateByQuery(e,t){throw"Implement"}static execAction(e,t){t.visitURL(e.url),t.blurLocationBar()}get iconType(){return"star.fill"}get icon(){return $icon(this.iconType,$rgba(140,140,140,.8),$size(13,13))}}class c extends l{constructor(e,t,i){super(e,t),this.tabIndex=i}get iconType(){return"macwindow"}static execAction(e,t){t.blurLocationBar(),t.selectTab(e.tabIndex)}static async generateByQuery(e,t){const i=t.tabs.map(e=>e.url),s=t.tabs.map(e=>e.title);return(await a(e,i,s,!1,!0)).map(e=>new c(s[e],i[e],e))}}class u extends l{constructor(e,t){super(e,t)}get iconType(){return"clock"}static execAction(e,t){t.visitURL(e.url),t.blurLocationBar()}static async generateByQuery(e,t){const i=t._pastURLs,s=t._pastTitles;return(await a(e,i,s,!0,!0)).map(e=>new u(s[e],i[e]))}}class h extends l{constructor(e,t){super(e,t)}get iconType(){return"star.fill"}static execAction(e,t){t.visitURL(e.url),t.blurLocationBar()}static async generateByQuery(e,t){let i=t.bookmarks;return(await a(e,i.map(e=>e.url),i.map(e=>e.title),!1,!0)).map(e=>new h(i[e].title,i[e].url))}}const d="https://www.google.com/complete/search?client=chrome-omni&gs_ri=chrome-ext&oit=1&cp=1&pgcl=7&q=";class p extends l{constructor(e,t){super(e,"Suggested by "+t)}get urlReadable(){return this.url}get iconType(){return"magnifyingglass"}static execAction(e,t){t.visitURL(e.text),t.blurLocationBar()}static generateByQuery(e,t,i=d){const s=d+encodeURIComponent(e);return new Promise((e,t)=>{$http.request({method:"GET",url:s,handler:function(i){i.error?t(i.error):e(i.data[1].map(e=>new p(e,"Google")))}})})}}class b extends l{constructor(e,t){super(e,t)}get iconType(){return"dollarsign.square"}static generateByQuery(e,t){const i=t.config.SCRAPBOX_USER,s=`https://scrapbox.io/api/pages/${i}/search/query?skip=0&sort=updated&limit=30&q=`+encodeURIComponent(e);return new Promise((e,t)=>{$http.request({method:"GET",url:s,handler:function(t){t.error||401===t.data.statusCode?e(null):e(t.data.pages.map(e=>new b(e.title,`https://scrapbox.io/${i}/${encodeURIComponent(e.title)}`)))}})})}}t.LocationBarCompletion=class extends s{constructor(e,t,i=40){super(),this._browser=e,this._locationBar=null,this._canceled=!1,this.TOPBAR_HEIGHT=t,this.CANDIDATE_HEIGHT=i,this.defineState({suggestionList:null,suggestionIndex:-1})}set locationBar(e){this._locationBar=e}get suggestionSelected(){return this.state.suggestionIndex>=0}set suggestions(e){this.setState({suggestionList:e,suggestionIndex:-1})}reset(){this._canceled=!1}cancel(){this._canceled=!0,this.suggestions=null}get canceled(){return this._canceled}decide(e){if("number"!=typeof e&&(e=this.state.suggestionIndex),e>=0){let t=this.state.suggestionList[e];t.constructor.execAction(t,this._browser)}}selectNextCandidate(){this.state.suggestionIndex<0?this.setState({suggestionIndex:0}):this.setState({suggestionIndex:(this.state.suggestionIndex+1)%this.state.suggestionList.length})}selectPreviousCandidate(){let e=-1;e=this.state.suggestionIndex<0?this.state.suggestionList.length-1:this.state.suggestionIndex-1<0?this.state.suggestionList.length-1:this.state.suggestionIndex-1,this.setState({suggestionIndex:e})}build(){const e=this.state.suggestionList,t=this.state.suggestionIndex,i={props:{},views:[{type:"view",props:{id:"completion-rectangle",bgcolor:$color("#FFFFFF")},layout:$layout.fill,views:[{type:"view",layout:(e,t)=>{e.width.equalTo(32),e.height.equalTo(t.super)},views:[{type:"button",props:{id:"completion-icon",bgcolor:$color("clear"),align:$align.center},layout:(e,t)=>{e.centerX.equalTo(t.super),e.centerY.equalTo(t.super)}}]},{type:"view",layout:(e,t)=>{e.width.equalTo(t.super).offset(32),e.height.equalTo(t.super),e.left.equalTo(32)},views:[{type:"label",props:{id:"completion-label",align:$align.left,font:$font(15),borderWidth:0,textColor:$color("#000000")},layout:(e,t)=>{e.top.inset(3),e.left.inset(3),e.width.equalTo(t.super.width)}},{type:"label",props:{id:"completion-url",align:$align.left,font:$font(12),textColor:$rgba(0,0,0,.6)},layout:(e,t)=>{e.bottom.inset(3),e.left.inset(3),e.width.equalTo(t.super.width)}}]}]}]},s=(e||[]).map((e,i)=>{let s={"completion-label":{text:e.text,tabIndex:i},"completion-url":{text:e.urlReadable},"completion-icon":{}};return/^[0-9]+$/.test(e.iconType)?s["completion-icon"].icon=e.icon:s["completion-icon"].symbol=e.iconType,i===t&&(s["completion-rectangle"]={bgcolor:n}),s});let a=0===(e||[]).length;return{type:"list",events:{didSelect:(e,t)=>{this.decide(t.row)}},props:{id:"completion-list",rowHeight:this.CANDIDATE_HEIGHT,template:i,data:s,bgColor:r,borderWidth:1,radius:5,borderColor:o,hidden:a},layout:(t,i)=>{let s=this._locationBar.element;t.centerX.equalTo(s.centerX),t.width.equalTo(s).priority(1),t.height.equalTo(this.CANDIDATE_HEIGHT*(e||[]).length).priority(1);const o=this.TOPBAR_HEIGHT*this._locationBar.HEIGHT_RATIO;t.top.equalTo(o+(this.TOPBAR_HEIGHT-o)/2+1)}}}},t.Suggestion=l,t.SuggestionTab=c,t.SuggestionBookmark=h,t.SuggestionWebQuery=p,t.SuggestionHistory=u,t.SuggestionScrapbox=b},function(e,t,i){const{Component:s}=i(0),o=15,r=$rgba(250,250,250,.9),n=$color("#000000"),a=$color("#cccccc"),l=$color("#666666"),c=$color("#bbbbbb");class u extends s{constructor(e){super(),this.config=e.config,this._browser=e,this._eventHandlers={didSelect:(e,t)=>{this._browser.selectTab(t.row)},didLongPress:(t,i)=>{const s=[["Copy",()=>e.copyTabInfo(i.row)],["Close other tabs",()=>e.closeTabsBesides(i.row)],["Open in external browser",()=>e.openInExternalBrowser(i.row)]];$ui.menu({items:s.map(e=>e[0]),handler:function(e,t){t>=0&&s[t][1]()},finished:function(e){}})}},this._tabTemplate={props:{},views:[{type:"view",props:{id:"tab-rectangle"},layout:$layout.fill,views:[{type:"label",props:{id:"tab-name",align:$align.center,font:$font(this.config.SIZE_TAB_FONT)},layout:(e,t)=>{e.height.equalTo(t.super.height),e.width.equalTo(t.super.width).offset(-30),e.left.equalTo(t.super.left).offset(25)}}]},{type:"button",props:{id:"close-button",icon:$icon("225",$rgba(140,140,140,.8),$size(o,o)),bgcolor:$color("clear")},events:{tapped:async()=>{e.closeTab(e.tabs[e.currentTabIndex])}},layout:(e,t)=>{e.left.equalTo(t.super.left).offset(5),e.top.inset(5)}}]}}get tabNames(){return this._browser.tabs.map(e=>e.title)}get currentTabIndex(){return this._browser.currentTabIndex}build(){const e=this.tabNames.map((e,t)=>t===this.currentTabIndex?{"tab-name":{text:e},"tab-rectangle":{bgcolor:r,textColor:n,tabIndex:t}}:{"tab-name":{text:e},"tab-rectangle":{bgcolor:a,textColor:l,tabIndex:t},"close-button":{hidden:!0}});return e&&0!==e.length?this._buildTabList(e):null}}t.TabListHorizontal=class extends u{constructor(e){super(e),this.config=e.config}_buildTabList(e){return{type:"view",props:{},layout:(e,t)=>{e.width.equalTo(t.super.width),e.height.equalTo(this.config.TAB_HEIGHT+1),e.top.equalTo(t.super),e.left.equalTo(t.super)},views:[{type:"matrix",events:this._eventHandlers,props:{id:"pages-tab",columns:e.length,itemHeight:this.config.TAB_HEIGHT,spacing:0,template:this._tabTemplate,data:e},layout:(e,t)=>{e.width.equalTo(t.super),e.height.equalTo(this.config.TAB_HEIGHT),e.top.equalTo(t.super),e.left.equalTo(t.super)}},{type:"view",props:{bgcolor:$color("#CCCCCC")},layout:(e,t)=>{e.width.equalTo(t.super),e.height.equalTo(1),e.top.equalTo(this.config.TAB_HEIGHT),e.left.equalTo(t.super)}}]}}},t.TabListVertical=class extends u{constructor(e){super(e),this.config=e.config}_buildTabList(e){return{type:"view",props:{userInteractionEnabled:!1},layout:(e,t)=>{e.width.equalTo(t.super),e.height.equalTo(t.super),e.top.equalTo(t.super),e.left.equalTo(t.super)},views:[{type:"list",events:this._eventHandlers,props:{id:"pages-tab",rowHeight:this.config.TAB_HEIGHT,template:this._tabTemplate,data:e,bgcolor:c,borderWidth:0},layout:(e,t)=>{e.width.equalTo(this.config.TAB_VERTICAL_WIDTH),e.height.equalTo(t.super),e.top.equalTo(t.super),e.left.equalTo(t.super)}},{type:"view",props:{bgcolor:$color("#CCCCCC")},layout:(e,t)=>{e.width.equalTo(t.super),e.height.equalTo(1),e.top.equalTo(t.super),e.left.equalTo(t.super)}}]}}}},function(module,exports,__webpack_require__){const{TabContentWebView:TabContentWebView}=__webpack_require__(4),{Component:Component}=__webpack_require__(0),{ToolBar:ToolBar}=__webpack_require__(5),{ToolBarButton:ToolBarButton}=__webpack_require__(6),{ToolBarButtonContainer:ToolBarButtonContainer}=__webpack_require__(7),{LocationBar:LocationBar}=__webpack_require__(8),{LocationBarCompletion:LocationBarCompletion}=__webpack_require__(1),{TabListHorizontal:TabListHorizontal}=__webpack_require__(2),{TabListVertical:TabListVertical}=__webpack_require__(2);function readMinified(e){return $file.exists(e+".min.js")?$file.read(e+".min.js").string:$file.read(e+".js").string}function loadTabInfo(){try{let[e,t,i]=JSON.parse($file.read("last-tabs.json").string.trim());if(e.length!==i.length)throw"Invalid";return[e,t,i]}catch(e){return[[],0,[]]}}function saveTabInfo(e){let t=e.tabs.map(e=>e.url),i=e.tabs.map(e=>e.title),s=[t,e.currentTabIndex,i];$file.write({data:$data({string:JSON.stringify(s)}),path:"last-tabs.json"})}function loadHistory(){try{let e=JSON.parse($file.read("history.json").string.trim());if(!Array.isArray(e.pages))throw"Error";if(!Array.isArray(e.bookmarks))throw"Error";return e}catch(e){return{page:{urls:[],titles:[]},bookmark:[]}}}function saveHistory(e){$file.write({data:$data({string:JSON.stringify(e.history)}),path:"history.json"})}function loadConfig(){let userSettings=readMinified("./strings/settings");eval(userSettings);const config={sites:[]};return exports.setup(config,{marked:()=>null}),config}function readUserScript(){let e=readMinified("./strings/settings");return readMinified("./strings/content-script").replace("/*@preserve SETTINGS_HERE*/","\n"+e+"\n")}function convertURLLikeInputToURL(e){return/^https?:/.test(e)?e:"https://www.google.com/search?q="+encodeURIComponent(e)}class TabAndContentContainer extends Component{constructor(e){super(),this._verticalOffset=e}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(e,t)=>{e.width.equalTo(t.super.width),e.height.equalTo(t.super.height).offset(-this._verticalOffset),e.top.equalTo(t.super.top).offset(this._verticalOffset),e.left.equalTo(t.super)}}}}class TabContentHolder extends Component{constructor(e){super(),this.config=e.config}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(e,t)=>{this.config.TAB_VERTICAL?(e.width.equalTo(t.super.width).offset(-this.config.TAB_VERTICAL_WIDTH),e.height.equalTo(t.super.height),e.top.equalTo(t.super.top),e.left.equalTo(t.super).offset(this.config.TAB_VERTICAL_WIDTH)):(e.width.equalTo(t.super.width),e.height.equalTo(t.super.height),e.top.equalTo(t.super.top).offset(this.config.TAB_HEIGHT),e.left.equalTo(t.super))}}}}class TabBrowser extends Component{constructor(e,t,i){super(),this._config=i,this.userScript=e,this.currentTabIndex=0,this.tabs=[],this._pastURLs=[],this._pastTitles=[],this._onInitialize=t;const s=i.TOPBAR_HEIGHT;this.id="browser-container";let o=this;let r=new ToolBarButtonContainer("left",.25),n=new ToolBarButtonContainer("right",.25),a=new LocationBarCompletion(o,s);const l=new LocationBar(this,a,.5);o._locationBar=l,a.locationBar=l;const c=new ToolBar(s);this._toolbar=c;const u=new TabAndContentContainer(s);this._tabAndContentContainer=u;const h=new TabContentHolder(o);this._tabContentHolder=h;const d=i.TAB_VERTICAL?new TabListVertical(o):new TabListHorizontal(o);this._tabList=d,n.addChild(new ToolBarButton("rectangle.on.rectangle",()=>o.selectTabsByPanel())).addChild(new ToolBarButton("plus",()=>o.createNewTab(null,!0))).addChild(new ToolBarButton("square.and.arrow.up",()=>o.share())),r.addChild(new ToolBarButton("multiply",()=>$app.close())).addChild(new ToolBarButton("chevron.left",()=>o.goBack())).addChild(new ToolBarButton("chevron.right",()=>o.goForward())).addChild(new ToolBarButton("book",()=>o.showBookmark())),c.addChild(r).addChild(l).addChild(n),u.addChild(d).addChild(h),o.addChild(a).addChild(c).addChild(u),this.render()}get config(){return this._config}build(){return{props:{id:this.id,title:"iKeySnail",statusBarHidden:this.config.HIDE_STATUSBAR,navBarHidden:this.config.HIDE_TOOLBAR},events:{appeared:e=>{this._onInitialize(this)}}}}focusLocationBar(){this._locationBar.focus()}blurLocationBar(){this._locationBar.blur()}decideLocationBarCandidate(){this._locationBar.decideCandidate()}selectLocationBarNextCandidate(){this._locationBar.selectNextCandidate()}selectLocationBarPreviousCandidate(){this._locationBar.selectPreviousCandidate()}get history(){return{page:{urls:this._pastURLs,titles:this._pastTitles},bookmark:{}}}set history(e){this._pastURLs=e.page.urls,this._pastTitles=e.page.titles,this._bookmark=e.bookmark}addHistory(e,t){this._pastURLs.push(e),this._pastTitles.push(t)}get bookmarks(){return this.config.sites.map(e=>({title:e.alias,url:e.url}))}get selectedTab(){return this.tabs[this.currentTabIndex]}selectTabsByPanel(){let e=this.tabs.map((e,t)=>({text:e.title,url:e.url})),t=this.tabs.indexOf(this.selectedTab);this.selectedTab.evalScript(`\n__keysnail__.runPanel(${JSON.stringify(e)}, {\n  toggle: true,\n  initialIndex: ${t},\n  action: index => $notify("selectTabByIndex", { index })\n});\n        `)}onTabStartLoading(e){e===this.selectedTab&&this.setURLView(e.url)}onTabTitleDetermined(e){this.addHistory(e.url,e.title)}onTabURLChanged(e){e===this.selectedTab&&this.setURLView(e.url)}focusContent(){this.selectedTab.select()}setURLView(e){this._locationBar.setURLText(e)}visitURL(e){e=convertURLLikeInputToURL(e),this.selectedTab.visitURL(e),this.setURLView(e),this.selectedTab.select()}showBookmark(){this.selectedTab.showBookmark()}goBack(){this.selectedTab.goBack()}goForward(){this.selectedTab.goForward()}share(){let e=this.selectedTab;$share.sheet([e.url,e.title])}scrap(){let e=this.selectedTab,t=`#bookmark\n\n${e.url}\n`;this.createNewTab(`https://scrapbox.io/stillpedant/${encodeURIComponent(e.title)}?body=${encodeURIComponent(t)}`,!0)}copyTabInfo(e){$clipboard.set({type:"public.plain-text",value:this.tabs[e].url})}openInExternalBrowser(e){$app.openURL(this.tabs[e].url)}closeTabsBesides(e){let t=this.tabs[e];this.tabs.forEach((t,i)=>{i!==e&&t.loaded&&t.destroy()}),this.tabs=[t],this.selectTab(0)}closeTab(e){if(this.tabs.length<=1)this.tabs[0].visitURL(this.config.NEW_PAGE_URL);else{e.visitURL(null);let t=this.tabs.indexOf(e);e.removeMe(),t>=0&&this.tabs.splice(t,1),this.selectTab(Math.max(0,this.currentTabIndex-1))}}_createNewTabInternal(e,t=null){let i=new TabContentWebView(this,this.config,e,this.userScript);return t&&(i._title=t),this._tabContentHolder.addChild(i),this.tabs.push(i),i}createNewTabs(e,t=-1,i=[]){e.forEach((e,t)=>{let s=i?i[t]:null;this._createNewTabInternal(e,s)}),t>=0&&this.selectTab(t)}createNewTab(e,t=!1){e||(e=this.config.NEW_PAGE_URL);let i=this._createNewTabInternal(e);t?this.selectTab(this.tabs.indexOf(i)):this._tabAndContentContainer.render()}selectTab(e){this.currentTabIndex=e,this.tabs.forEach((t,i)=>{i===e?(t.select(),this.setURLView(t.url)):t.deselect()}),this._tabList.render()}selectNextTab(){this.selectTab((this.currentTabIndex+1)%this.tabs.length)}selectPreviousTab(){this.currentTabIndex-1<0?this.selectTab(this.tabs.length-1):this.selectTab(this.currentTabIndex-1)}}function startSession(e){const t=loadConfig();let i=[],s=0;try{let[e,t,o]=loadTabInfo();s=t,o=o||[];for(let t=0;t<e.length;++t)i.push({url:e[t],title:o[t]})}catch(e){}let o=new TabBrowser(readUserScript(),o=>{o.history=loadHistory(),i.length?(o.createNewTabs(i.map(e=>e.url),s,i.map(e=>e.title)),e?o.createNewTab(e,!0):o.selectTab(s)):o.createNewTab(e||t.NEW_TAB_URL,!0)},t);$app.listen({ready:()=>{$define({type:"UIResponder",events:{"_keyCommandForEvent:":e=>null}});let e=!1,i=!1,s=!1,r=o._locationBar.runtime;const n={option:226,meta:227,Escape:41,Enter:40,ctrl:224," ":44};for(let e=0;e<27;++e)n[String.fromCharCode(97+e)]=4+e;if(t.SWAP_COMMAND_OPTION){let e=n.option;n.option=n.meta,n.meta=e}Object.freeze(n);const a=function(e){const t={};return Object.keys(e).forEach(i=>{t[e[i]]=i}),t}(n);let l={"ctrl-p":()=>o.selectLocationBarPreviousCandidate(),"ctrl-n":()=>o.selectLocationBarNextCandidate(),"ctrl-m":()=>o.decideLocationBarCandidate(),"ctrl-g":()=>o.blurLocationBar(),Escape:()=>o.blurLocationBar()},c={"ctrl-meta-j":()=>o.selectNextTab(),"ctrl-meta-k":()=>o.selectPreviousTab(),"meta-l":()=>o.focusLocationBar()};t.CAPTURE_CTRL_SPACE&&(c["ctrl- "]=()=>o.selectedTab.dispatchCtrlSpace()),$define({type:"UIApplication",events:{"_handleKeyUIEvent:":t=>{const o=t.$__keyCode(),u=t.$__isKeyDown(),h=a[o];if(!a.hasOwnProperty(o))return self.$ORIG__handleKeyUIEvent(t);let d=c;if(r.$isFirstResponder()&&(d=l),o===n.ctrl)e=u;else if(o===n.meta)i=u;else if(o===n.option)s=u;else{let o=h;if(i&&(o="meta-"+o),e&&(o="ctrl-"+o),s&&(o="alt-"+o),d.hasOwnProperty(o)){if("ctrl-m"===o&&r.$markedTextRange())return self.$ORIG__handleKeyUIEvent(t);if(u)try{d[o]()}catch(e){}return null}}return self.$ORIG__handleKeyUIEvent(t)}}})},exit:()=>{try{$objc("RedBoxCore").$cleanClass("UIResponder"),$objc("RedBoxCore").$cleanClass("UIApplication")}catch(e){console.error(e)}saveTabInfo(o),saveHistory(o)}})}startSession($context.query.url||null)},function(e,t,i){const{Component:s}=i(0);function o(e,t,i=!0){return i?new Promise((i,s)=>{e.element.eval({script:t,handler:(e,t)=>{t||"object"==typeof e?s(t):i(e)}})}):(e.element.eval({script:t}),null)}t.TabContentWebView=class extends s{constructor(e,t,i="http://www.google.com",s=""){super(),this.browser=e,this.config=t,this.userScript=s,this._title=i,this.url=i,this._loaded=!1;let r=this;this.eventHandler={log:({message:e})=>{this.config.DEBUG_CONSOLE&&log(e)},titleDetermined:({title:e})=>{"about:blank"===this.element.url?this.title="New Tab":this.title=e,this.browser.onTabTitleDetermined(this)},didFinish:async e=>{},didStart:e=>{this.title="Loading ...",this.browser.onTabStartLoading(this)},urlDidChange:async e=>{this.title=await o(r,"document.title",!0),this.browser.onTabURLChanged(this)},exitApplication:()=>$app.close(),share:()=>this.browser.share(),scrap:()=>this.browser.scrap(),message:({message:e,duration:t})=>{$ui.toast(e,t||3)},paste:()=>{o(r,`__keysnail__.insertText('${escape($clipboard.text)}', true)`,!1)},closeTab:()=>{this.browser.closeTab(r)},createNewTab:()=>{this.browser.createNewTab("about:blank",!0),this.browser.focusLocationBar()},selectNextTab:()=>{this.browser.selectNextTab()},selectPreviousTab:()=>{this.browser.selectPreviousTab()},focusLocationBar:()=>{this.browser.focusLocationBar()},copyText:({text:e})=>{$clipboard.set({type:"public.plain-text",value:e})},openClipboardURL:async()=>{let e=await o(r,"__keysnail__.getSelectedText()");e||(e=$clipboard.text),this.browser.createNewTab(convertURLLikeInputToURL(e),!0)},selectTabsByPanel:()=>{e.selectTabsByPanel()},selectTabByIndex:({index:e})=>{this.browser.selectTab(e)}}}destroy(){this.visitURL(null),this.removeMe()}get selected(){return this===this.browser.selectedTab}get loaded(){return this._loaded}deselect(){this.element&&(this.element.hidden=!0)}select(){this.load(),this.element.hidden&&(this.element.hidden=!1),this.runtimeWebView.$becomeFirstResponder()}set url(e){this._url=e,this._loaded&&(this.element.url=e)}get url(){let e=null;return(e=this.element?this.element.url:this._url)||this.config.NEW_PAGE_URL}get element(){return $(this.id)}get title(){return this._title}set title(e){this._title=e,this.browser._tabList.render()}showBookmark(){o(this,"__keysnail__.startSiteSelector(true)")}goBack(){this.element.goBack()}goForward(){this.element.goForward()}visitURL(e){this.url=e}load(){this._loaded||(this._loaded=!0,this.render(),this.runtimeWebView.$setAllowsBackForwardNavigationGestures(!0))}get runtimeWebView(){return this.element.runtimeValue()}unload(){this._loaded&&(this._loaded=!1,this.element.url=null,this.element.remove())}dispatchCtrlSpace(){o(this,'__keysnail__.dispatchKey("ctrl- ", false, true)')}build(){if(!this._loaded)return null;let e=this.url,t=this.userScript;return{type:"web",props:{id:this.id,ua:this.config.USER_AGENT,script:t,hidden:!1,url:e},events:this.eventHandler,layout:(e,t)=>{e.edges.equalTo(t.super)}}}evalScript(e){return new Promise((t,i)=>{this.element.eval({script:e,handler:(e,s)=>{s||"object"==typeof e?i(s):t(e)}})})}}},function(e,t,i){const{Component:s}=i(0);t.ToolBar=class extends s{constructor(e){super(),this._height=e}build(){return{type:"view",props:{bgcolor:$color("clear")},layout:(e,t)=>{e.width.equalTo(t.super),e.height.equalTo(this._height)}}}}},function(e,t,i){const{Component:s}=i(0),o=18,r=$color("#007AFF");t.ToolBarButton=class extends s{constructor(e,t){super(),this._iconOrSymbol=e,this._onTapped=t,this._padding=30}build(){const e={type:"button",props:{bgcolor:$color("clear")},events:{tapped:this._onTapped},layout:(e,t)=>{const i=this._parent.element.views,s=i.indexOf(t);if("left"===this._parent.align){const o=0===s?t.super.left:i[s-1].right;e.left.equalTo(o).offset(this._padding)}else{const o=0===s?t.super.right:i[s-1].left;e.right.equalTo(o).offset(-this._padding)}e.centerY.equalTo(t.super),e.height.equalTo(t.super)}};return/^[0-9]+$/.test(this._iconOrSymbol)?e.props.icon=$icon(this._iconOrSymbol,r,$size(o,o)):(e.props.symbol=this._iconOrSymbol,e.props.tintColor=r),e}}},function(e,t,i){const{Component:s}=i(0);t.ToolBarButtonContainer=class extends s{constructor(e="left",t=.5,i=$color("clear")){super(),this._align=e,this._bgcolor=i,this.WIDTH_RATIO=t}get align(){return this._align}build(){return{type:"view",props:{bgcolor:this._bgcolor},layout:(e,t)=>{e.top.equalTo(t.super.top),e.height.equalTo(t.super.height),e.width.equalTo(t.super.width).multipliedBy(this.WIDTH_RATIO),"left"===this._align?e.left.inset(0):e.right.inset(0)}}}}},function(e,t,i){const{Component:s}=i(0),{LocationBarCompletion:o}=i(1),r="#2B9E46";t.LocationBar=class extends s{constructor(e,t,i=.5,s=.65){super(),this._browser=e,this._completion=t,this.WIDTH_RATIO=i,this.HEIGHT_RATIO=s}focus(){this.element.focus(),this.runtime.$selectAll(),this._completion.reset()}blur(){this.element.blur(),this._browser.focusContent()}setURLText(e){this.element.text=decodeURIComponent(e)}build(){let e=this._browser,t=null;const s=function(e,t=500){let i=null;return(...s)=>{i&&clearTimeout(i),i=setTimeout(async()=>{e(...s)},t)}}(async(t,s)=>{if(t.length<1)return void(this._completion.suggestions=null);if(this._completion.canceled)return;const o=this._browser.config.LOCATIONBAR_SUGGESTIONS.map(s=>{if("string"==typeof s){s=i(1)[s]}return s.generateByQuery(t,e)});let r=await Promise.all(o);r=r.filter(e=>!!e).map(e=>e.slice(0,5)).flat(),this._completion.canceled||(this._completion.suggestions=r)},200);return{type:"input",props:{id:this.id,textColor:$color(r),align:$align.center},layout:(e,t)=>{e.centerY.equalTo(t.super.center),e.height.equalTo(t.super.height).multipliedBy(this.HEIGHT_RATIO),e.width.equalTo(t.super.width).multipliedBy(this.WIDTH_RATIO),e.centerX.equalTo(t.super.center).priority(100)},events:{didBeginEditing:e=>{e.align=$align.left,e.textColor=$rgba(0,0,0,1),t=e.text},tapped:e=>{this.focus()},returned:e=>{this.decideCandidate()},didEndEditing:e=>{this._completion.cancel(),e.align=$align.center,e.textColor=$color(r),e.text=t},changed:e=>{(e=>/https?:\/\//.test(e))(e.text)||s(e.text,e)}}}}decideCandidate(){this._completion.suggestionSelected?this._completion.decide():(this._browser.visitURL(this.element.text),this._browser.focusContent())}selectNextCandidate(){this._completion.selectNextCandidate()}selectPreviousCandidate(){this._completion.selectPreviousCandidate()}}}]);